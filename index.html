<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Ponto Seguro</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; background: #f8f9fa; color: #333; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 450px; margin: 0 auto; border: 1px solid #dee2e6; }
        
        h1 { font-size: 1.2rem; color: #495057; margin-bottom: 25px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        
        button { background: #0d6efd; color: white; border: none; padding: 14px; font-size: 1rem; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 500; margin-bottom: 12px; transition: background 0.2s; }
        button:hover { background: #0b5ed7; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .btn-outline { background: transparent; border: 1px solid #6c757d; color: #6c757d; }
        .btn-maps { background: #198754; display: none; } 
        
        /* Status Box Animada */
        .status-container { margin-top: 20px; padding: 15px; border-radius: 8px; background: #f8f9fa; border: 1px solid #dee2e6; text-align: left; }
        
        .metric-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .metric-label { font-size: 0.9rem; color: #666; }
        .metric-value { font-family: monospace; font-size: 1.1rem; font-weight: bold; color: #333; }
        
        /* Cores da Precis√£o */
        .acc-bad { color: #dc3545; }    /* Vermelho > 50m */
        .acc-med { color: #fd7e14; }    /* Laranja 20-50m */
        .acc-good { color: #198754; }   /* Verde < 20m */

        .hint-box { font-size: 0.85rem; background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin-top: 10px; display: none; border: 1px solid #ffeeba; }

        #resultArea { display: none; margin-top: 25px; border-top: 1px solid #dee2e6; padding-top: 20px; }
        .final-coord { font-size: 1.3rem; font-weight: bold; color: #212529; background: #e9ecef; padding: 15px; border-radius: 6px; margin: 15px 0; letter-spacing: 0.5px; }
    </style>
</head>
<body>

<div class="card">
    <h1>üìç Captura de Localiza√ß√£o</h1>

    <div id="startScreen">
        <p style="color:#666; font-size:0.95rem; margin-bottom:20px;">
            Esteja em local aberto para melhor precis√£o.
        </p>
        <button onclick="iniciarGPS()">Iniciar Captura</button>
    </div>

    <div id="processingScreen" style="display:none;">
        <div class="status-container">
            <div style="font-weight: bold; margin-bottom: 15px; display:flex; align-items:center;">
                <span style="color:#0d6efd; margin-right:8px;" class="blink">‚óè</span> 
                <span id="statusText">Buscando Sat√©lites...</span>
            </div>
            
            <div class="metric-row">
                <span class="metric-label">Precis√£o Atual:</span>
                <span class="metric-value" id="liveAcc">--</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Meta Exigida:</span>
                <span class="metric-value">20 m</span>
            </div>

            <div id="smartHint" class="hint-box">
                üí° <b>Dica:</b> A precis√£o est√° baixa. Ligue o <b>Wi-Fi</b> do celular (ajuda na triangula√ß√£o) e v√° para c√©u aberto.
            </div>
        </div>

        <button class="btn-outline" onclick="forcarParada()" style="margin-top:15px;">
            Usar precis√£o atual (For√ßar)
        </button>
    </div>

    <div id="resultArea">
        <div style="color: #198754; font-weight: bold; margin-bottom: 5px;">‚úÖ Localiza√ß√£o Registrada</div>
        <div style="font-size:0.8rem; color:#666; margin-bottom:15px;">Dados prontos para uso</div>
        
        <div class="final-coord">
            <div id="finalLat">--</div>
            <div id="finalLon">--</div>
        </div>
        <div style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">
            Precis√£o final: <span id="finalAccDisplay">--</span> metros
        </div>

        <button onclick="copiarDados()">üìã Copiar Coordenadas</button>
        <button class="btn-maps" id="btnMaps" onclick="abrirMaps()">üó∫Ô∏è Ver no Google Maps</button>
        <button class="btn-outline" onclick="location.reload()">Nova Captura</button>
    </div>
</div>

<style>
@keyframes blinker { 50% { opacity: 0; } }
.blink { animation: blinker 1.5s linear infinite; }
</style>

<script>
    let watchID = null;
    let latAtual = 0, lonAtual = 0, accAtual = 0;
    let bestAcc = 99999; // Guarda a melhor precis√£o vista

    function iniciarGPS() {
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('processingScreen').style.display = 'block';

        if (!navigator.geolocation) {
            alert("Erro: Seu navegador n√£o suporta GPS.");
            return;
        }

        const options = {
            enableHighAccuracy: true,
            timeout: Infinity, // NUNCA d√° timeout, fica tentando at√© conseguir
            maximumAge: 0
        };

        // Come√ßa a monitorar
        watchID = navigator.geolocation.watchPosition(atualizarTela, tratarErro, options);
    }

    function atualizarTela(position) {
        latAtual = position.coords.latitude;
        lonAtual = position.coords.longitude;
        accAtual = position.coords.accuracy;

        // Atualiza display
        const accElement = document.getElementById('liveAcc');
        accElement.innerText = accAtual.toFixed(0) + " m";
        
        // Cores baseadas na qualidade
        if(accAtual <= 20) {
            accElement.className = "metric-value acc-good";
            document.getElementById('statusText').innerText = "Sinal Excelente!";
            finalizar(); // Meta atingida!
        } else if (accAtual <= 50) {
            accElement.className = "metric-value acc-med";
            document.getElementById('statusText').innerText = "Calibrando (Quase l√°)...";
            document.getElementById('smartHint').style.display = "none";
        } else {
            accElement.className = "metric-value acc-bad";
            document.getElementById('statusText').innerText = "Sinal Fraco (Ajustando...)";
            // Mostra dica se estiver muito ruim (>100m)
            if(accAtual > 100) document.getElementById('smartHint').style.display = "block";
        }

        // Guarda o melhor resultado caso o usu√°rio force a parada
        if(accAtual < bestAcc) {
            bestAcc = accAtual;
        }
    }

    function tratarErro(error) {
        console.warn("Erro GPS: " + error.code);
        // N√£o mostramos erro pro usu√°rio, deixamos tentando.
        // Se for permiss√£o negada (1), a√≠ avisamos:
        if(error.code == 1) {
            alert("Erro: Voc√™ negou a permiss√£o de localiza√ß√£o. Ative nas configura√ß√µes do site.");
            location.reload();
        }
    }

    function finalizar() {
        if(watchID !== null) {
            navigator.geolocation.clearWatch(watchID);
            watchID = null;
        }

        document.getElementById('processingScreen').style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('btnMaps').style.display = 'block';

        document.getElementById('finalLat').innerText = latAtual;
        document.getElementById('finalLon').innerText = lonAtual;
        document.getElementById('finalAccDisplay').innerText = accAtual.toFixed(1);
    }

    function forcarParada() {
        if(latAtual === 0) {
            alert("Aguarde pelo menos a primeira leitura (mesmo que imprecisa).");
        } else {
            finalizar();
        }
    }

    function copiarDados() {
        const texto = `${latAtual}, ${lonAtual}`;
        navigator.clipboard.writeText(texto).then(() => {
            alert("Coordenadas copiadas!");
        });
    }

    function abrirMaps() {
        if(latAtual && lonAtual) {
            window.open(`https://www.google.com/maps?q=${latAtual},${lonAtual}`, '_blank');
        }
    }
</script>

</body>
</html>